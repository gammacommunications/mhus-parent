
lifecycle:
- name: deploy
  steps:
    # reset and pull all projects
  - title: Git Reset
    target: con.git
    arguments:
    - reset --HARD
    - pull
    
  # new versions
  
  - title: Calculate new versions
    target: con.calculateNewVersion
  - title: Set new version properties
    target: con.updatePomProperties
    selector:
      version.changed: true
  
  # Update and build parent
  
  - title: Set new project version
    target: con.maven
    arguments:
    - versions:set
    - "-DnewVersion=${project.version}"
    selector:
      group: parent
  - title: Install parent pom
    target: con.maven
    arguments:
    - clean
    - install
    selector:
      group: parent

  # update all other projects
  
  - title: Set new parent version
    target: con.updatePomParentVersion
    selector:
      version.changed: true
    properties:
      version: ${projects.mhus-parent.version}
  - title: Set new project version
    target: con.maven
    arguments:
    - versions:set
    - "-DnewVersion=${project.version}"
    selector:
      version.changed: true
  # compile all others and push
  - title: Compile Projects
    target: con.maven
    arguments:
    - clean
    - install
    - "-P release-mhus"
    sort: order
    selector:
      group: bundle
      version.changed: true
  - title: Deploy Projects
    target: con.maven
    arguments:
    - deploy
    - '-P release-mhus'
    sort: order
    selector:
      group: bundle
      version.changed: true
  # create tags
  - title: Git Commit
    target: con.git
    arguments:
    - 'add *'
    - 'commit -m "${project.version}"'
    selector:
      group: bundle
      version.changed: true
    properties:
      ignoreReturnCode: true
  - title: Git Tag
    target: con.git
    arguments:
    - 'tag "${project.version}"'
    - 'push origin --tags'
    - 'push'
    selector:
      group: bundle
      version.changed: true
    
  # save versions
  - title: Save version history
    target: con.persistNewVersions
  # create parent tag
  # commit parent
  # set next SNAPSHOT
  - title: Calculate new Snapshot
    target: con.nextSnapshotVersions
  - title: Set new version properties
    target: con.updatePomProperties
    selector:
      group: parent
  - title: Set new parent version
    target: con.updatePomParentVersion
    selector:
      version.changed: true
    properties:
      version: ${projects.parent.version}
  # commit
  - title: Git Commit
    target: con.git
    arguments:
    - add *
    - commit -m "${project.version}"
    selector:
      version.changed: true
  
- name: snapshot
  steps:   
  
  